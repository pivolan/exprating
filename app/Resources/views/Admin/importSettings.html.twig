{% extends '_layout/_profile.html.twig' %}
{% block title %}Настройки импорта{% endblock %}
{% block profile_body %}
    <div class="col-md-6">
        <h1>Категории Exprating</h1>
        <button type="button" class="btn btn-success" onclick="create_node()">Создать</button>
        <button type="button" class="btn btn-warning" onclick="rename_node()">Переименовать</button>

        <div id="treeCategory" class="well height-full"></div>
    </div>
    <div class="col-md-6">
        <h1>Категории irecommend</h1>
        <button type="button" class="btn btn-info" onclick="deselect_all_import()">Снять выделение</button>
        <div id="treeCategoryImport" class="well height-full"></div>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="{{ asset('js/external/jstree.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('js/external/jquery.scrollTo.min.js') }}"></script>
    <script type="text/javascript">
        var selected_by_event = false;
        function create_node() {
            var ref = $('#treeCategory').jstree(true),
                    sel = ref.get_selected();
            if (!sel.length) {
                return false;
            }
            sel = sel[0];
            sel = ref.create_node(sel, {"type": "file", a_attr: {data_path: ''}, data: {created: true, actions: []}});
            if (sel) {
                ref.edit(sel);
            }
        }
        function rename_node() {
            var ref = $('#treeCategory').jstree(true),
                    sel = ref.get_selected();
            if (!sel.length) {
                return false;
            }
            sel = sel[0];
            ref.edit(sel);
        }
        function deselect_all_import() {
            $('#treeCategoryImport').jstree(true).deselect_all();
        }
        (function ($, undefined) {
            "use strict";
            var anchor = document.createElement('A');
            var span = document.createElement('span');
            anchor.href = '#';
            anchor.target = '_blank';
            span.className = 'glyphicon glyphicon-edit';
            anchor.appendChild(span);

            $.jstree.defaults.actions = $.noop;
            $.jstree.plugins.actions = function (options, parent) {
                this.redraw_node = function (obj, deep, callback, force_draw) {
                    obj = parent.redraw_node.call(this, obj, deep, callback, force_draw);
                    if (obj) {
                        var node = (this.get_node(obj));
                        for (var key in node.data.actions) {
                            var span_class = node.data.actions[key].span_class;
                            var url = node.data.actions[key].url;
                            var tmp = anchor.cloneNode(true);
                            tmp.href = url;
                            tmp.firstChild.className = span_class;
                            if (node.data.actions[key].text) {
                                tmp.firstChild.textContent = node.data.actions[key].text;
                            }
                            if (!url) {
                                obj.insertBefore(tmp.firstChild, obj.childNodes[2]);
                            } else {
                                obj.insertBefore(tmp, obj.childNodes[2]);
                            }
                        }
                    }
                    return obj;
                };
            };
        })(jQuery);
        $('#treeCategory').jstree({
            core: {
                check_callback: true,
                data: [
                    {% for category in categories %}
                    {% set parent_slug = category.parent.slug|default('#') %}
                    {% if category.parent.slug|default('#') == 'root' %}{% set parent_slug = '#' %}{% endif %}
                    {
                        id: '{{ category.slug }}',
                        parent: '{{ parent_slug }}',
                        text: '{{ category.name|raw }}',
                        a_attr: {
                            href: '{{ path('category_admin_categories', {'slug': category.slug}) }}',
                            data_path: '{{ categoryAssociate[category.slug] }}',
                        },
                        data: {
                            actions: [
                                {
                                    span_class: "glyphicon glyphicon-edit",
                                    url: '{{ path('category_admin_categories', {'slug': category.slug}) }}',
                                },
                                {
                                    span_class: "glyphicon glyphicon-share",
                                    url: '{{ path("product_list", {"slug":category.slug, "peopleGroup": "dlya-vseh"}) }}'
                                },
                            ]
                        }
                    },
                    {% endfor %}
                ]
            },
            plugins: ['dnd', 'actions']
        }).on('select_node.jstree', function (node, selected, event) {
            var selected_nodes = $('#treeCategoryImport').jstree(true).get_selected();
            if (selected_nodes.length && !selected_by_event) {
                var category_slug = selected.node.id;
                var category_text = selected.node.text;
                console.log(selected.node.text);

                var alias_category_id = selected_nodes[0];
                var node = $('#treeCategoryImport').jstree(true).get_node(alias_category_id);
                if (confirm('Вы хотите поменять "' + node.data.actions[0].text + '" на "' + selected.node.a_attr.data_path + '"')) {
                    $.ajax('{{ path('admin_import_settings_change') }}', {
                        method: "POST",
                        data: {category_slug: category_slug, alias_category_id: alias_category_id},
                        success: function (data) {
                            var html = '<div class="message-box alert-success">' +
                                    '<span class="close">X</span>' +
                                    '<p>Изменения успешно сохранены</p>' +
                                    '</div>';
                            $('div.alert-message').html(html);
                            setTimeout(function () {
                                $('div.alert-message').html('');
                            }, 2000);
                            node.a_attr.data_relation = category_slug;
                            node.data.actions[0].text = selected.node.a_attr.data_path;
                            $('#treeCategoryImport').jstree(true).set_text(node, node.text);
                        }
                    });
                } else {
                    var dataRelation = node.a_attr.data_relation;
                    $('#treeCategory').jstree(true).deselect_all();
                    $('#treeCategory').jstree(true).close_all();
                    if (dataRelation) {
                        selected_by_event = true;
                        $('#treeCategory').jstree(true).select_node(dataRelation);
                        $('#treeCategory').stop(true).scrollTo('#' + dataRelation);
                        $('#treeCategory').jstree(true).open_node(dataRelation);
                    }
                }
            }
            selected_by_event = false;
        }).on('rename_node.jstree', function (event, entity) {
            var node = entity.node;
            if (!node.data.created) {
                if (confirm('Сохранить новое имя ' + entity.text + '?')) {
                    node.a_attr.data_path = node.a_attr.data_path.replace(entity.old, entity.text);
                } else {
                    $('#treeCategory').jstree(true).set_text(node, entity.old);
                }
            } else {
                node.data.created = false;
            }
        }).on('move_node.jstree', function (e, data) {
            console.log(data);
            $.ajax({
                url: '{{ path("admin_category_move") }}',
                methot: 'post',
                data: {
                    category: data.node.id,
                    position: data.position,
                    parent: data.parent,
                },
                success: function () {
                    var html = '<div class="message-box alert-success">' +
                            '<span class="close">X</span>' +
                            '<p>Изменения успешно сохранены</p>' +
                            '</div>';
                    $('div.alert-message').html(html);
                    setTimeout(function () {
                        $('div.alert-message').html('');
                    }, 2000);
                }
            })
        });
        $('#treeCategoryImport').jstree({
            core: {
                data: [
                    {% for category in categoriesImport %}
                    {% set categoryName = '' %}
                    {% set categoryNameHtml = '' %}
                    {% if category.aliasCategory %}
                    {% set categoryNameHtml = '(<span class="small text-success">' ~ categoryAssociate[category.aliasCategory.categoryExpratingId]|default(null) ~ '</span>)' %}
                    {% set categoryName = categoryAssociate[category.aliasCategory.categoryExpratingId]|default(null) %}
                    {% endif %}
                    {
                        id: '{{ category.id }}',
                        parent: '{{ category.parent.id|default('#') }}',
                        text: '{{ category.name|raw }}',
                        opened: true,
                        a_attr: {
                            href: '#',
                            data_relation: '{{ category.aliasCategory.categoryExpratingId|default(null) }}',
                            data_current_path: '{{ categoryName }}'
                        },
                        state: {
                            opened: true
                        },
                        data: {
                            actions: [
                                {
                                    span_class: 'small text-success',
                                    text: '{{ categoryName }}'
                                },
                                {
                                    span_class: 'glyphicon glyphicon-share',
                                    url: '{{ category.url|raw }}'
                                }
                            ]
                        }
                    },
                    {% endfor %}
                ]
            },
            plugins: ['actions']
        }).on('select_node.jstree', function (node, selected, event) {
            var dataRelation = selected.node.a_attr.data_relation;
            $('#treeCategory').jstree(true).deselect_all();
            $('#treeCategory').jstree(true).close_all();
            if (dataRelation) {
                selected_by_event = true;
                $('#treeCategory').jstree(true).select_node(dataRelation);
                $('#treeCategory').stop(true).scrollTo('#' + dataRelation);
                $('#treeCategory').jstree(true).open_node(dataRelation);
            }
        });
        $(document).on('click', 'a.external', function () {
            var href = $(this).attr('href');
            window.open(href, '_blank');
        });
    </script>
{% endblock %}